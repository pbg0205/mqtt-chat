<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${room.name}"></title>
    <script src="/webjars/jquery/3.6.0/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
</head>
<body>
<h1 th:text="${room.name}"></h1>
<h2 th:text="${member.getNickname()}"></h2>
<div class="content" data-room-id="{{room.id}}" data-member="{{member}}">
    <ul class="chat_box">
    </ul>
    <label>
        <input name="message">
    </label>
    <button class="send">보내기</button>
</div>
<script>
    $(function () {
        let chatBox = $('.chat_box');
        let messageInput = $('input[name=message]');
        let sendBtn = $('.send');
        let roomId = '[[${room.id}]]';
        let member = '[[${member.getNickname()}]]';

        let endpoint = "/stomp-chat";
        let sock = new SockJS(endpoint);
        let client = Stomp.over(sock);
        client.debug = function (e) {
        };

        client.connect({}, function () {
            client.send(
                '/publish/chat/join',
                {},
                JSON.stringify({
                    chatRoomId: roomId,
                    type: 'JOIN',
                    writer: member
                })
            );

            client.subscribe(
                '/subscribe/chat/room/' + roomId,
                function (chat) {
                    let content = JSON.parse(chat.body);
                    chatBox.append('<li>' + '(' + content.writer + ')' + content.message + '</li>')
                }
            );
        });

        sendBtn.click(function () {
            let message = messageInput.val();
            client.send(
                '/publish/chat/message',
                {},
                JSON.stringify({
                    chatRoomId: roomId,
                    type: 'CHAT',
                    message: message,
                    writer: member
                })
            );

            messageInput.val('');
        });
    });
</script>
</body>
</html>
